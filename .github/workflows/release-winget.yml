name: Publish to Winget

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag to publish (e.g., v1.31.24.27401). Leave empty to use latest stable release.'
        required: false
        type: string
      dry_run:
        description: 'Dry run (validate manifest without submitting PR)'
        required: false
        type: boolean
        default: false

jobs:
  publish-winget:
    name: "Publish to Winget"
    runs-on: self-hosted

    steps:
    - name: Determine release tag
      id: release
      shell: pwsh
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        if ("${{ inputs.release_tag }}" -ne "") {
          $tag = "${{ inputs.release_tag }}"
        } else {
          # Get latest release (excluding pre-releases)
          $release = gh release list --repo ${{ github.repository }} --limit 20 --json tagName,isPrerelease | ConvertFrom-Json | Where-Object { -not $_.isPrerelease } | Select-Object -First 1
          $tag = $release.tagName
        }

        # Extract version from tag (v1.31.24.27401 -> 1.31.24.27401)
        $version = $tag -replace '^v', ''

        # For Winget, we need a 3-part version (1.31.24)
        $versionParts = $version -split '\.'
        $wingetVersion = "$($versionParts[0]).$($versionParts[1]).$($versionParts[2])"

        Write-Output "tag=$tag" >> $env:GITHUB_OUTPUT
        Write-Output "version=$version" >> $env:GITHUB_OUTPUT
        Write-Output "winget_version=$wingetVersion" >> $env:GITHUB_OUTPUT

        Write-Host "Release tag: $tag"
        Write-Host "Full version: $version"
        Write-Host "Winget version: $wingetVersion"

    - name: Download release assets
      shell: pwsh
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        $tag = "${{ steps.release.outputs.tag }}"
        $version = "${{ steps.release.outputs.version }}"

        # Create temp directory for downloads
        New-Item -ItemType Directory -Force -Path "./winget-assets"

        # Download Windows assets
        $assets = @(
          "fluxzy-cli-$version-win-x64.zip",
          "fluxzy-cli-$version-win-x86.zip",
          "fluxzy-cli-$version-win-arm64.zip"
        )

        foreach ($asset in $assets) {
          Write-Host "Downloading $asset..."
          gh release download $tag --repo ${{ github.repository }} --pattern $asset --dir "./winget-assets"
        }

        # List downloaded files
        Get-ChildItem "./winget-assets"

    - name: Calculate SHA256 hashes
      id: hashes
      shell: pwsh
      run: |
        $version = "${{ steps.release.outputs.version }}"

        $hashX64 = (Get-FileHash "./winget-assets/fluxzy-cli-$version-win-x64.zip" -Algorithm SHA256).Hash
        $hashX86 = (Get-FileHash "./winget-assets/fluxzy-cli-$version-win-x86.zip" -Algorithm SHA256).Hash
        $hashArm64 = (Get-FileHash "./winget-assets/fluxzy-cli-$version-win-arm64.zip" -Algorithm SHA256).Hash

        Write-Output "hash_x64=$hashX64" >> $env:GITHUB_OUTPUT
        Write-Output "hash_x86=$hashX86" >> $env:GITHUB_OUTPUT
        Write-Output "hash_arm64=$hashArm64" >> $env:GITHUB_OUTPUT

        Write-Host "SHA256 x64: $hashX64"
        Write-Host "SHA256 x86: $hashX86"
        Write-Host "SHA256 ARM64: $hashArm64"

    - name: Install wingetcreate
      shell: pwsh
      run: |
        # Install wingetcreate
        Invoke-WebRequest -Uri https://aka.ms/wingetcreate/latest -OutFile wingetcreate.exe

    - name: Create and submit Winget manifest
      shell: pwsh
      env:
        WINGET_GITHUB_TOKEN: ${{ secrets.WINGET_GITHUB_TOKEN }}
      run: |
        $version = "${{ steps.release.outputs.version }}"
        $wingetVersion = "${{ steps.release.outputs.winget_version }}"
        $tag = "${{ steps.release.outputs.tag }}"
        $dryRun = "${{ inputs.dry_run }}"

        $urlBase = "https://github.com/${{ github.repository }}/releases/download/$tag"

        $urlX64 = "$urlBase/fluxzy-cli-$version-win-x64.zip"
        $urlX86 = "$urlBase/fluxzy-cli-$version-win-x86.zip"
        $urlArm64 = "$urlBase/fluxzy-cli-$version-win-arm64.zip"

        Write-Host "Creating Winget manifest for version $wingetVersion"
        Write-Host "URLs:"
        Write-Host "  x64: $urlX64"
        Write-Host "  x86: $urlX86"
        Write-Host "  ARM64: $urlArm64"

        $args = @(
          "update",
          "Fluxzy.Fluxzy",
          "--version", $wingetVersion,
          "--urls", "$urlX64|x64", "$urlX86|x86", "$urlArm64|arm64"
        )

        if ($dryRun -eq "true") {
          Write-Host "Dry run mode - validating manifest only"
          # In dry run, just create the manifest locally without submitting
          $args += @("--out", "./manifest-output")
          & ./wingetcreate.exe @args

          Write-Host "Generated manifest files:"
          Get-ChildItem "./manifest-output" -Recurse
        } else {
          # Submit PR to winget-pkgs
          $args += @("--token", $env:WINGET_GITHUB_TOKEN, "--submit")
          & ./wingetcreate.exe @args
        }

    - name: Upload manifest artifacts
      if: inputs.dry_run
      uses: actions/upload-artifact@v4
      with:
        name: winget-manifest
        path: ./manifest-output/
        retention-days: 7
